{"version":3,"names":["NativeContentProtectionRegistry","constructor","undefined","event","requestId","integrationId","keySystemId","drmConfig","console","log","factory","getFactory","currentIntegration","integration","build","NativeModules","ContentProtectionModule","onBuildProcessed","resultString","request","getIntegration","onCertificateRequest","result","fromNativeCertificateRequest","isBufferSource","nativeResponse","toNativeCertificateResponseResult","onCertificateRequestProcessedAsCertificate","modifiedNativeRequest","toNativeCertificateRequest","onCertificateRequestProcessedAsRequest","response","onCertificateResponse","responseResult","fromNativeCertificateResponse","modifiedNativeResponse","onCertificateResponseProcessed","onLicenseRequest","fromNativeLicenseRequest","toNativeLicenseResponseResult","onLicenseRequestProcessedAsLicense","toNativeLicenseRequest","onLicenseRequestProcessedAsRequest","onLicenseResponse","fromNativeLicenseResponse","onLicenseResponseProcessed","fairplaySkdUrl","extractFairplayContentId","contentId","onExtractFairplayContentIdProcessed","emitter","NativeEventEmitter","addListener","onBuildIntegrationRequest","onExtractFairplayContentId","registerContentProtectionIntegration","integrationFactory","registeredFactories","push","find","init","ContentProtectionRegistry"],"sources":["ContentProtectionRegistry.ts"],"sourcesContent":["import type { CertificateRequest, ContentProtectionAPI, DRMConfiguration, LicenseRequest } from 'react-native-theoplayer';\nimport type { KeySystemId } from 'react-native-theoplayer';\nimport type { ContentProtectionIntegrationFactory } from 'react-native-theoplayer';\nimport { NativeEventEmitter, NativeModules } from 'react-native';\nimport type { ContentProtectionIntegration } from 'react-native-theoplayer';\nimport type { NativeContentProtectionEvent } from './NativeContentProtectionEvent';\nimport { fromNativeLicenseRequest, NativeLicenseRequest, toNativeLicenseRequest } from './NativeLicenseRequest';\nimport { fromNativeLicenseResponse, NativeLicenseResponse, toNativeLicenseResponseResult } from './NativeLicenseResponse';\nimport { fromNativeCertificateRequest, NativeCertificateRequest, toNativeCertificateRequest } from './NativeCertificateRequest';\nimport { fromNativeCertificateResponse, NativeCertificateResponse, toNativeCertificateResponseResult } from './NativeCertificateResponse';\nimport { isBufferSource } from '../utils/TypeUtils';\n\ninterface WrappedContentProtectionIntegrationFactory {\n  integrationId: string;\n  keySystemId: string;\n  integrationFactory: ContentProtectionIntegrationFactory;\n}\n\ninterface WrappedContentProtectionIntegration {\n  integrationId: string;\n  keySystemId: string;\n  integration: ContentProtectionIntegration;\n}\n\ninterface BuildEvent extends NativeContentProtectionEvent {\n  drmConfig: DRMConfiguration;\n}\n\ninterface ExtractFaiplayContentIdEvent extends NativeContentProtectionEvent {\n  fairplaySkdUrl: string;\n}\n\nexport class NativeContentProtectionRegistry implements ContentProtectionAPI {\n  private emitter: NativeEventEmitter;\n  private registeredFactories: WrappedContentProtectionIntegrationFactory[] = [];\n  private currentIntegration: WrappedContentProtectionIntegration | undefined = undefined;\n\n  constructor() {\n    this.emitter = new NativeEventEmitter(NativeModules.ContentProtectionModule);\n    this.emitter.addListener('onBuildIntegration', this.onBuildIntegrationRequest);\n    this.emitter.addListener('onCertificateRequest', this.onCertificateRequest);\n    this.emitter.addListener('onCertificateResponse', this.onCertificateResponse);\n    this.emitter.addListener('onLicenseRequest', this.onLicenseRequest);\n    this.emitter.addListener('onLicenseResponse', this.onLicenseResponse);\n    this.emitter.addListener('onExtractFairplayContentId', this.onExtractFairplayContentId);\n  }\n\n  registerContentProtectionIntegration(integrationId: string, keySystemId: KeySystemId, integrationFactory: ContentProtectionIntegrationFactory) {\n    this.registeredFactories.push({\n      integrationId,\n      keySystemId,\n      integrationFactory,\n    });\n    NativeModules.ContentProtectionModule.registerContentProtectionIntegration(integrationId, keySystemId);\n  }\n\n  private getFactory(integrationId: string, keySystemId: string): ContentProtectionIntegrationFactory | undefined {\n    return this.registeredFactories.find((init) => init.integrationId === integrationId && init.keySystemId === keySystemId)?.integrationFactory;\n  }\n\n  private getIntegration(integrationId: string, keySystemId: string): ContentProtectionIntegration | undefined {\n    return this.currentIntegration?.integrationId === integrationId && this.currentIntegration?.keySystemId === keySystemId\n      ? this.currentIntegration?.integration\n      : undefined;\n  }\n\n  private onBuildIntegrationRequest = (event: BuildEvent) => {\n    const { requestId, integrationId, keySystemId, drmConfig } = event;\n    console.log('ContentProtectionModule', `onBuildIntegrationRequest ${integrationId} ${keySystemId}`);\n    const factory = this.getFactory(integrationId, keySystemId);\n    if (factory) {\n      this.currentIntegration = {\n        integrationId,\n        keySystemId,\n        integration: factory.build(drmConfig),\n      };\n      NativeModules.ContentProtectionModule.onBuildProcessed({ requestId, resultString: 'success' });\n    } else {\n      NativeModules.ContentProtectionModule.onBuildProcessed({\n        requestId,\n        resultString: 'failed',\n      });\n    }\n  };\n\n  private onCertificateRequest = async (request: NativeCertificateRequest) => {\n    const { requestId, integrationId, keySystemId } = request;\n    console.log('ContentProtectionModule', `onCertificateRequest ${integrationId} ${keySystemId}`);\n    const integration = this.getIntegration(integrationId, keySystemId);\n    if (integration?.onCertificateRequest) {\n      const result = await integration.onCertificateRequest(fromNativeCertificateRequest(request));\n      // TODO: we also want to support ArrayBufferView results\n      if (isBufferSource(result)) {\n        const nativeResponse = toNativeCertificateResponseResult(requestId, integrationId, keySystemId, result as ArrayBuffer);\n        NativeModules.ContentProtectionModule.onCertificateRequestProcessedAsCertificate(nativeResponse);\n      } else if (result as CertificateRequest) {\n        const modifiedNativeRequest = toNativeCertificateRequest(requestId, integrationId, keySystemId, result as CertificateRequest);\n        NativeModules.ContentProtectionModule.onCertificateRequestProcessedAsRequest(modifiedNativeRequest);\n      }\n    } else {\n      NativeModules.ContentProtectionModule.onCertificateRequestProcessedAsRequest(request);\n    }\n  };\n\n  private onCertificateResponse = async (response: NativeCertificateResponse) => {\n    const { requestId, integrationId, keySystemId } = response;\n    console.log('ContentProtectionModule', `onCertificateResponse ${integrationId} ${keySystemId}`);\n    const integration = this.getIntegration(integrationId, keySystemId);\n    if (integration?.onCertificateResponse) {\n      const responseResult = await integration.onCertificateResponse(fromNativeCertificateResponse(response));\n      // TODO: we also want to support ArrayBufferView results\n      const modifiedNativeResponse = toNativeCertificateResponseResult(requestId, integrationId, keySystemId, responseResult as ArrayBuffer);\n      NativeModules.ContentProtectionModule.onCertificateResponseProcessed(modifiedNativeResponse);\n    } else {\n      NativeModules.ContentProtectionModule.onCertificateResponseProcessed(response);\n    }\n  };\n\n  private onLicenseRequest = async (request: NativeLicenseRequest) => {\n    const { requestId, integrationId, keySystemId } = request;\n    console.log('ContentProtectionModule', `onLicenseRequest ${integrationId} ${keySystemId}`);\n    const integration = this.getIntegration(integrationId, keySystemId);\n    // Optionally let the custom integration modify the request.\n    if (integration?.onLicenseRequest) {\n      const result = await integration.onLicenseRequest(fromNativeLicenseRequest(request));\n      // TODO: we also want to support ArrayBufferView results\n      if (isBufferSource(result)) {\n        const nativeResponse = toNativeLicenseResponseResult(requestId, integrationId, keySystemId, result as ArrayBuffer);\n        NativeModules.ContentProtectionModule.onLicenseRequestProcessedAsLicense(nativeResponse);\n      } else if (result as LicenseRequest) {\n        const modifiedNativeRequest = toNativeLicenseRequest(requestId, integrationId, keySystemId, result as LicenseRequest);\n        NativeModules.ContentProtectionModule.onLicenseRequestProcessedAsRequest(modifiedNativeRequest);\n      }\n    } else {\n      NativeModules.ContentProtectionModule.onLicenseRequestProcessedAsRequest(request);\n    }\n  };\n\n  private onLicenseResponse = async (response: NativeLicenseResponse) => {\n    const { requestId, integrationId, keySystemId } = response;\n    console.log('ContentProtectionModule', `onLicenseResponse ${integrationId} ${keySystemId}`);\n    const integration = this.getIntegration(integrationId, keySystemId);\n    if (integration?.onLicenseResponse) {\n      const responseResult = await integration.onLicenseResponse(fromNativeLicenseResponse(response));\n      // TODO: we also want to support ArrayBufferView results\n      const modifiedNativeResponse = toNativeLicenseResponseResult(requestId, integrationId, keySystemId, responseResult as ArrayBuffer);\n      NativeModules.ContentProtectionModule.onLicenseResponseProcessed(modifiedNativeResponse);\n    } else {\n      NativeModules.ContentProtectionModule.onLicenseResponseProcessed(response);\n    }\n  };\n\n  private onExtractFairplayContentId = async (event: ExtractFaiplayContentIdEvent) => {\n    const { integrationId, keySystemId, fairplaySkdUrl, requestId } = event;\n    console.log('ContentProtectionModule', `onExtractFairplayContentId ${integrationId} ${keySystemId}`);\n    const integration = this.getIntegration(integrationId, keySystemId);\n    if (integration?.extractFairplayContentId) {\n      const contentId = await integration.extractFairplayContentId(fairplaySkdUrl);\n      NativeModules.ContentProtectionModule.onExtractFairplayContentIdProcessed({\n        requestId,\n        contentId,\n      });\n    } else {\n      const contentId = fairplaySkdUrl;\n      NativeModules.ContentProtectionModule.onExtractFairplayContentIdProcessed({\n        requestId,\n        contentId,\n      });\n    }\n  };\n}\n\nexport const ContentProtectionRegistry = new NativeContentProtectionRegistry();\n"],"mappings":";;;;;;;AAGA;;AAGA;;AACA;;AACA;;AACA;;AACA;;;;AAsBO,MAAMA,+BAAN,CAAsE;EAK3EC,WAAW,GAAG;IAAA;;IAAA,6CAH8D,EAG9D;;IAAA,4CAFgEC,SAEhE;;IAAA,mDA6BuBC,KAAD,IAAuB;MACzD,MAAM;QAAEC,SAAF;QAAaC,aAAb;QAA4BC,WAA5B;QAAyCC;MAAzC,IAAuDJ,KAA7D;MACAK,OAAO,CAACC,GAAR,CAAY,yBAAZ,EAAwC,6BAA4BJ,aAAc,IAAGC,WAAY,EAAjG;MACA,MAAMI,OAAO,GAAG,KAAKC,UAAL,CAAgBN,aAAhB,EAA+BC,WAA/B,CAAhB;;MACA,IAAII,OAAJ,EAAa;QACX,KAAKE,kBAAL,GAA0B;UACxBP,aADwB;UAExBC,WAFwB;UAGxBO,WAAW,EAAEH,OAAO,CAACI,KAAR,CAAcP,SAAd;QAHW,CAA1B;;QAKAQ,0BAAA,CAAcC,uBAAd,CAAsCC,gBAAtC,CAAuD;UAAEb,SAAF;UAAac,YAAY,EAAE;QAA3B,CAAvD;MACD,CAPD,MAOO;QACLH,0BAAA,CAAcC,uBAAd,CAAsCC,gBAAtC,CAAuD;UACrDb,SADqD;UAErDc,YAAY,EAAE;QAFuC,CAAvD;MAID;IACF,CA9Ca;;IAAA,8CAgDiB,MAAOC,OAAP,IAA6C;MAC1E,MAAM;QAAEf,SAAF;QAAaC,aAAb;QAA4BC;MAA5B,IAA4Ca,OAAlD;MACAX,OAAO,CAACC,GAAR,CAAY,yBAAZ,EAAwC,wBAAuBJ,aAAc,IAAGC,WAAY,EAA5F;MACA,MAAMO,WAAW,GAAG,KAAKO,cAAL,CAAoBf,aAApB,EAAmCC,WAAnC,CAApB;;MACA,IAAIO,WAAJ,aAAIA,WAAJ,eAAIA,WAAW,CAAEQ,oBAAjB,EAAuC;QACrC,MAAMC,MAAM,GAAG,MAAMT,WAAW,CAACQ,oBAAZ,CAAiC,IAAAE,sDAAA,EAA6BJ,OAA7B,CAAjC,CAArB,CADqC,CAErC;;QACA,IAAI,IAAAK,yBAAA,EAAeF,MAAf,CAAJ,EAA4B;UAC1B,MAAMG,cAAc,GAAG,IAAAC,4DAAA,EAAkCtB,SAAlC,EAA6CC,aAA7C,EAA4DC,WAA5D,EAAyEgB,MAAzE,CAAvB;;UACAP,0BAAA,CAAcC,uBAAd,CAAsCW,0CAAtC,CAAiFF,cAAjF;QACD,CAHD,MAGO,IAAIH,MAAJ,EAAkC;UACvC,MAAMM,qBAAqB,GAAG,IAAAC,oDAAA,EAA2BzB,SAA3B,EAAsCC,aAAtC,EAAqDC,WAArD,EAAkEgB,MAAlE,CAA9B;;UACAP,0BAAA,CAAcC,uBAAd,CAAsCc,sCAAtC,CAA6EF,qBAA7E;QACD;MACF,CAVD,MAUO;QACLb,0BAAA,CAAcC,uBAAd,CAAsCc,sCAAtC,CAA6EX,OAA7E;MACD;IACF,CAjEa;;IAAA,+CAmEkB,MAAOY,QAAP,IAA+C;MAC7E,MAAM;QAAE3B,SAAF;QAAaC,aAAb;QAA4BC;MAA5B,IAA4CyB,QAAlD;MACAvB,OAAO,CAACC,GAAR,CAAY,yBAAZ,EAAwC,yBAAwBJ,aAAc,IAAGC,WAAY,EAA7F;MACA,MAAMO,WAAW,GAAG,KAAKO,cAAL,CAAoBf,aAApB,EAAmCC,WAAnC,CAApB;;MACA,IAAIO,WAAJ,aAAIA,WAAJ,eAAIA,WAAW,CAAEmB,qBAAjB,EAAwC;QACtC,MAAMC,cAAc,GAAG,MAAMpB,WAAW,CAACmB,qBAAZ,CAAkC,IAAAE,wDAAA,EAA8BH,QAA9B,CAAlC,CAA7B,CADsC,CAEtC;;QACA,MAAMI,sBAAsB,GAAG,IAAAT,4DAAA,EAAkCtB,SAAlC,EAA6CC,aAA7C,EAA4DC,WAA5D,EAAyE2B,cAAzE,CAA/B;;QACAlB,0BAAA,CAAcC,uBAAd,CAAsCoB,8BAAtC,CAAqED,sBAArE;MACD,CALD,MAKO;QACLpB,0BAAA,CAAcC,uBAAd,CAAsCoB,8BAAtC,CAAqEL,QAArE;MACD;IACF,CA/Ea;;IAAA,0CAiFa,MAAOZ,OAAP,IAAyC;MAClE,MAAM;QAAEf,SAAF;QAAaC,aAAb;QAA4BC;MAA5B,IAA4Ca,OAAlD;MACAX,OAAO,CAACC,GAAR,CAAY,yBAAZ,EAAwC,oBAAmBJ,aAAc,IAAGC,WAAY,EAAxF;MACA,MAAMO,WAAW,GAAG,KAAKO,cAAL,CAAoBf,aAApB,EAAmCC,WAAnC,CAApB,CAHkE,CAIlE;;MACA,IAAIO,WAAJ,aAAIA,WAAJ,eAAIA,WAAW,CAAEwB,gBAAjB,EAAmC;QACjC,MAAMf,MAAM,GAAG,MAAMT,WAAW,CAACwB,gBAAZ,CAA6B,IAAAC,8CAAA,EAAyBnB,OAAzB,CAA7B,CAArB,CADiC,CAEjC;;QACA,IAAI,IAAAK,yBAAA,EAAeF,MAAf,CAAJ,EAA4B;UAC1B,MAAMG,cAAc,GAAG,IAAAc,oDAAA,EAA8BnC,SAA9B,EAAyCC,aAAzC,EAAwDC,WAAxD,EAAqEgB,MAArE,CAAvB;;UACAP,0BAAA,CAAcC,uBAAd,CAAsCwB,kCAAtC,CAAyEf,cAAzE;QACD,CAHD,MAGO,IAAIH,MAAJ,EAA8B;UACnC,MAAMM,qBAAqB,GAAG,IAAAa,4CAAA,EAAuBrC,SAAvB,EAAkCC,aAAlC,EAAiDC,WAAjD,EAA8DgB,MAA9D,CAA9B;;UACAP,0BAAA,CAAcC,uBAAd,CAAsC0B,kCAAtC,CAAyEd,qBAAzE;QACD;MACF,CAVD,MAUO;QACLb,0BAAA,CAAcC,uBAAd,CAAsC0B,kCAAtC,CAAyEvB,OAAzE;MACD;IACF,CAnGa;;IAAA,2CAqGc,MAAOY,QAAP,IAA2C;MACrE,MAAM;QAAE3B,SAAF;QAAaC,aAAb;QAA4BC;MAA5B,IAA4CyB,QAAlD;MACAvB,OAAO,CAACC,GAAR,CAAY,yBAAZ,EAAwC,qBAAoBJ,aAAc,IAAGC,WAAY,EAAzF;MACA,MAAMO,WAAW,GAAG,KAAKO,cAAL,CAAoBf,aAApB,EAAmCC,WAAnC,CAApB;;MACA,IAAIO,WAAJ,aAAIA,WAAJ,eAAIA,WAAW,CAAE8B,iBAAjB,EAAoC;QAClC,MAAMV,cAAc,GAAG,MAAMpB,WAAW,CAAC8B,iBAAZ,CAA8B,IAAAC,gDAAA,EAA0Bb,QAA1B,CAA9B,CAA7B,CADkC,CAElC;;QACA,MAAMI,sBAAsB,GAAG,IAAAI,oDAAA,EAA8BnC,SAA9B,EAAyCC,aAAzC,EAAwDC,WAAxD,EAAqE2B,cAArE,CAA/B;;QACAlB,0BAAA,CAAcC,uBAAd,CAAsC6B,0BAAtC,CAAiEV,sBAAjE;MACD,CALD,MAKO;QACLpB,0BAAA,CAAcC,uBAAd,CAAsC6B,0BAAtC,CAAiEd,QAAjE;MACD;IACF,CAjHa;;IAAA,oDAmHuB,MAAO5B,KAAP,IAA+C;MAClF,MAAM;QAAEE,aAAF;QAAiBC,WAAjB;QAA8BwC,cAA9B;QAA8C1C;MAA9C,IAA4DD,KAAlE;MACAK,OAAO,CAACC,GAAR,CAAY,yBAAZ,EAAwC,8BAA6BJ,aAAc,IAAGC,WAAY,EAAlG;MACA,MAAMO,WAAW,GAAG,KAAKO,cAAL,CAAoBf,aAApB,EAAmCC,WAAnC,CAApB;;MACA,IAAIO,WAAJ,aAAIA,WAAJ,eAAIA,WAAW,CAAEkC,wBAAjB,EAA2C;QACzC,MAAMC,SAAS,GAAG,MAAMnC,WAAW,CAACkC,wBAAZ,CAAqCD,cAArC,CAAxB;;QACA/B,0BAAA,CAAcC,uBAAd,CAAsCiC,mCAAtC,CAA0E;UACxE7C,SADwE;UAExE4C;QAFwE,CAA1E;MAID,CAND,MAMO;QACL,MAAMA,SAAS,GAAGF,cAAlB;;QACA/B,0BAAA,CAAcC,uBAAd,CAAsCiC,mCAAtC,CAA0E;UACxE7C,SADwE;UAExE4C;QAFwE,CAA1E;MAID;IACF,CApIa;;IACZ,KAAKE,OAAL,GAAe,IAAIC,+BAAJ,CAAuBpC,0BAAA,CAAcC,uBAArC,CAAf;IACA,KAAKkC,OAAL,CAAaE,WAAb,CAAyB,oBAAzB,EAA+C,KAAKC,yBAApD;IACA,KAAKH,OAAL,CAAaE,WAAb,CAAyB,sBAAzB,EAAiD,KAAK/B,oBAAtD;IACA,KAAK6B,OAAL,CAAaE,WAAb,CAAyB,uBAAzB,EAAkD,KAAKpB,qBAAvD;IACA,KAAKkB,OAAL,CAAaE,WAAb,CAAyB,kBAAzB,EAA6C,KAAKf,gBAAlD;IACA,KAAKa,OAAL,CAAaE,WAAb,CAAyB,mBAAzB,EAA8C,KAAKT,iBAAnD;IACA,KAAKO,OAAL,CAAaE,WAAb,CAAyB,4BAAzB,EAAuD,KAAKE,0BAA5D;EACD;;EAEDC,oCAAoC,CAAClD,aAAD,EAAwBC,WAAxB,EAAkDkD,kBAAlD,EAA2G;IAC7I,KAAKC,mBAAL,CAAyBC,IAAzB,CAA8B;MAC5BrD,aAD4B;MAE5BC,WAF4B;MAG5BkD;IAH4B,CAA9B;;IAKAzC,0BAAA,CAAcC,uBAAd,CAAsCuC,oCAAtC,CAA2ElD,aAA3E,EAA0FC,WAA1F;EACD;;EAEOK,UAAU,CAACN,aAAD,EAAwBC,WAAxB,EAA8F;IAAA;;IAC9G,gCAAO,KAAKmD,mBAAL,CAAyBE,IAAzB,CAA+BC,IAAD,IAAUA,IAAI,CAACvD,aAAL,KAAuBA,aAAvB,IAAwCuD,IAAI,CAACtD,WAAL,KAAqBA,WAArG,CAAP,0DAAO,sBAAmHkD,kBAA1H;EACD;;EAEOpC,cAAc,CAACf,aAAD,EAAwBC,WAAxB,EAAuF;IAAA;;IAC3G,OAAO,+BAAKM,kBAAL,gFAAyBP,aAAzB,MAA2CA,aAA3C,IAA4D,gCAAKO,kBAAL,kFAAyBN,WAAzB,MAAyCA,WAArG,6BACH,KAAKM,kBADF,2DACH,uBAAyBC,WADtB,GAEHX,SAFJ;EAGD;;AAhC0E;;;AA4ItE,MAAM2D,yBAAyB,GAAG,IAAI7D,+BAAJ,EAAlC"}